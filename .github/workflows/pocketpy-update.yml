name: Check PocketPy Updates

on:
  schedule:
    # Run weekly on Sundays at 00:00 UTC
    - cron: '0 0 * * 0'
  workflow_dispatch:  # Allow manual trigger

jobs:
  check-update:
    name: Check for PocketPy Updates
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Check for new PocketPy version
        id: check
        run: |
          CURRENT_VERSION=$(cat pocketpy/POCKETPY_VERSION | tr -d '[:space:]')
          echo "current=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          LATEST_VERSION=$(curl -s https://api.github.com/repos/pocketpy/pocketpy/releases/latest | jq -r .tag_name | sed 's/^v//')
          echo "latest=$LATEST_VERSION" >> $GITHUB_OUTPUT

          if [ "$CURRENT_VERSION" != "$LATEST_VERSION" ]; then
            echo "update_available=true" >> $GITHUB_OUTPUT
          else
            echo "update_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue for update
        if: steps.check.outputs.update_available == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const current = '${{ steps.check.outputs.current }}';
            const latest = '${{ steps.check.outputs.latest }}';

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: 'pocketpy-update'
            });

            const existingIssue = issues.data.find(i => i.title.includes(latest));
            if (existingIssue) {
              console.log(`Issue for v${latest} already exists: #${existingIssue.number}`);
              return;
            }

            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Update PocketPy to v${latest}`,
              body: `A new version of PocketPy is available.

            **Current version:** v${current}
            **Latest version:** v${latest}

            ## Update Steps

            1. Download new version:
               \`\`\`bash
               ./scripts/check-pocketpy-version.sh --update
               \`\`\`

            2. Apply the required \`match\` soft keyword patch (see CLAUDE.md)

            3. Build and test:
               \`\`\`bash
               cd pocketpy && zig build -Doptimize=ReleaseSmall
               python3 tests/compat_runner.py --report
               \`\`\`

            4. Update embedded binaries in CLI stubs

            ## Release Notes
            https://github.com/pocketpy/pocketpy/releases/tag/v${latest}
            `,
              labels: ['pocketpy-update', 'dependencies']
            });

      - name: Summary
        run: |
          echo "## PocketPy Version Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Current:** v${{ steps.check.outputs.current }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Latest:** v${{ steps.check.outputs.latest }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.check.outputs.update_available }}" = "true" ]; then
            echo "- **Status:** ⚠️ Update available" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** ✅ Up to date" >> $GITHUB_STEP_SUMMARY
          fi
