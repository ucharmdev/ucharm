#!/usr/bin/env python3
"""
mcharm - μcharm CLI tool

Build beautiful, fast, tiny CLI applications with MicroPython.

Usage:
    mcharm build <script> -o <output> [--mode <mode>]
    mcharm new <name>
    mcharm run <script>
    mcharm --version
    mcharm --help
"""

import argparse
import os
import sys
from pathlib import Path

__version__ = "0.1.0"

SCRIPT_DIR = Path(__file__).parent.resolve()

LOGO = """
\033[36m┌┬┐┌─┐┬ ┬┌─┐┬─┐┌┬┐
││││  ├─┤├─┤├┬┘│││
┴ ┴└─┘┴ ┴┴ ┴┴└─┴ ┴\033[0m
\033[2mμcharm - Beautiful CLIs for MicroPython\033[0m
"""

TEMPLATE = '''#!/usr/bin/env micropython
"""
{name} - Built with μcharm
"""
import sys
sys.path.insert(0, "{microcharm_path}")

from microcharm import (
    style, box, spinner, progress,
    success, error, warning, info,
    select, confirm, prompt
)
from microcharm.table import table, key_value
import time


def main():
    box(
        "{name}\\n"
        "Built with μcharm",
        title="Welcome",
        border_color="cyan"
    )
    print()
    
    choice = select("What would you like to do?", [
        "Say hello",
        "Show status",
        "Exit"
    ])
    
    if choice == "Say hello":
        name = prompt("What's your name?", default="World")
        print()
        success("Hello, " + str(name) + "!")
    elif choice == "Show status":
        print()
        spinner("Checking systems...", duration=1)
        success("All systems operational")
    else:
        info("Goodbye!")


if __name__ == "__main__":
    main()
'''


def cmd_build(args):
    """Build a standalone executable."""
    # Import the build module
    sys.path.insert(0, str(SCRIPT_DIR / "tools"))
    import build
    
    if not os.path.exists(args.script):
        print(f"\033[31mError:\033[0m Script not found: {args.script}")
        sys.exit(1)
    
    print(LOGO)
    print(f"Building \033[1m{args.script}\033[0m...")
    print(f"Mode: \033[36m{args.mode}\033[0m")
    print()
    
    if args.mode == "single":
        build.build_single_file(args.script, args.output)
    elif args.mode == "executable":
        build.build_executable(args.script, args.output)
    elif args.mode == "universal":
        build.build_universal(args.script, args.output)
    
    print()
    print("\033[32mDone!\033[0m")


def cmd_new(args):
    """Create a new μcharm project."""
    name = args.name
    filename = name.lower().replace(" ", "_").replace("-", "_") + ".py"
    
    print(LOGO)
    print(f"Creating new project: \033[1m{name}\033[0m")
    print()
    
    if os.path.exists(filename):
        print(f"\033[31mError:\033[0m {filename} already exists")
        sys.exit(1)
    
    content = TEMPLATE.format(
        name=name,
        microcharm_path=str(SCRIPT_DIR)
    )
    
    with open(filename, "w") as f:
        f.write(content)
    
    os.chmod(filename, 0o755)
    
    print(f"\033[32mCreated:\033[0m {filename}")
    print()
    print("Run your app:")
    print(f"  \033[36mmicropython {filename}\033[0m")
    print()
    print("Build standalone binary:")
    print(f"  \033[36mmcharm build {filename} -o {name.lower()} --mode universal\033[0m")


def cmd_run(args):
    """Run a μcharm script with micropython."""
    import subprocess
    
    if not os.path.exists(args.script):
        print(f"\033[31mError:\033[0m Script not found: {args.script}")
        sys.exit(1)
    
    # Set up the path to include microcharm
    env = os.environ.copy()
    env["MICROPYPATH"] = str(SCRIPT_DIR)
    
    result = subprocess.run(
        ["micropython", args.script] + args.args,
        env=env
    )
    sys.exit(result.returncode)


def cmd_version(args):
    """Show version."""
    print(f"mcharm {__version__}")


def main():
    parser = argparse.ArgumentParser(
        description="μcharm - Beautiful CLIs for MicroPython",
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
Examples:
  mcharm new "My App"                    Create a new project
  mcharm run myapp.py                    Run with micropython
  mcharm build myapp.py -o myapp         Build executable
  mcharm build myapp.py -o app --mode universal  Build standalone
        """
    )
    parser.add_argument("-v", "--version", action="store_true", help="Show version")
    
    subparsers = parser.add_subparsers(dest="command")
    
    # build command
    build_parser = subparsers.add_parser("build", help="Build standalone executable")
    build_parser.add_argument("script", help="Python script to build")
    build_parser.add_argument("-o", "--output", required=True, help="Output path")
    build_parser.add_argument("-m", "--mode", 
                              choices=["single", "executable", "universal"],
                              default="universal",
                              help="Build mode (default: universal)")
    build_parser.set_defaults(func=cmd_build)
    
    # new command
    new_parser = subparsers.add_parser("new", help="Create new project")
    new_parser.add_argument("name", help="Project name")
    new_parser.set_defaults(func=cmd_new)
    
    # run command
    run_parser = subparsers.add_parser("run", help="Run script with micropython")
    run_parser.add_argument("script", help="Script to run")
    run_parser.add_argument("args", nargs="*", help="Arguments to pass to script")
    run_parser.set_defaults(func=cmd_run)
    
    args = parser.parse_args()
    
    if args.version:
        cmd_version(args)
    elif args.command:
        args.func(args)
    else:
        print(LOGO)
        parser.print_help()


if __name__ == "__main__":
    main()
